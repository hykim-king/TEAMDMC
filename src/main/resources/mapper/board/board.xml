<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.teamdmc.kemie.board">
 
    <!-- 검색 조건 : 10 - bTitle / 20 - bContents / 30 - bTitle + bContents / 40 - uNick -->
    <sql id="searchCondition">
        <where>  <!-- 조건을 타면 where절을 자동으로 붙이게~! -->
            <choose>
                <when test=" '10' == searchDiv and '' != searchWord ">
                    bTitle LIKE '%' || #{searchWord} || '%'
                </when>
                <when test=" '20' == searchDiv and '' != searchWord ">
                    bContents LIKE '%' || #{searchWord} || '%'
                </when>
                <when test=" '30' == searchDiv and '' != searchWord ">
                    bTitle LIKE '%' || #{searchWord} || '%' AND bContents LIKE #{searchWord} || '%' 
                </when> 
                <when test=" '40' == searchDiv and '' != searchWord ">
                    uNick LIKE '%' || #{searchWord} || '%'
                </when>
            </choose>
        </where>
    </sql>
    
    <!-- 조회 -->
    <select id="doRetrieve" parameterType="SearchVO" resultType="BoardVO">
        SELECT A.*, B.*
        FROM (
          SELECT TT1.rnum AS num,
                 TT1.b_seq,
                 TT1.b_title,
                 TT1.b_contents,
                 TT1.b_readcnt,
                 TT1.u_nick,
                 TO_CHAR(TT1.reg_dt,'yyyy-mm-dd hh24:mi:ss') AS reg_dt,
                 TT1.u_id,
                 TO_CHAR(TT1.mod_dt,'yyyy-mm-dd hh24:mi:ss') AS mod_dt 
          FROM (
              SELECT ROWNUM AS RNUM, T1.*
              FROM (
                 SELECT *
                 FROM board
                 <include refid="searchCondition" />
              ORDER BY reg_dt DESC
              )T1
        WHERE ROWNUM <![CDATA[ <= #{pageSize} * (#{pageNum}-1)+#{pageSize} ]]>
        )TT1
      <![CDATA[ WHERE rnum >= (#{pageSize} * (#{pageNum}-1)+1) ]]>
        )A
        CROSS JOIN (
        SELECT COUNT(*) AS totalCnt
        FROM board
        <include refid="searchCondition" />
        )B
    </select>
    
    <!-- 전체 삭제 -->
    <delete id="deleteAll">
        DELETE FROM board
    </delete>
    
    <!-- 단건 조회 -->
    <select id="doSelectOne" parameterType="BoardVO" resultType="BoardVO">
        SELECT b_seq as "bSeq",                                            
               b_title as "bTitle",                                            
               b_contents as "bContents",                                                                                 
               b_readcnt as "bReadCnt",                                           
               u_nick as "uNick",                                       
               TO_CHAR(reg_dt,'yyyy-mm-dd hh24:mi:ss') as "regDt",
               u_id as "uId",    
               TO_CHAR(mod_dt,'yyyy-mm-dd hh24:mi:ss') as "modDt"
        FROM  board
        WHERE u_id = #{uId}
    </select>
    
 
    <!-- 건수 세기 -->
    <select id="getCount" parameterType="BoardVO" resultType="int">
        SELECT COUNT(*) AS cnt
        FROM board
        WHERE b_readcnt LIKE #{bReadCnt} || '%'
    </select>
    <!-- 테스트용으로 생성한 객체에 readcnt 기준으로 카운트 셀수 있도록 설정해두었습니다 -->
    
    <update id="doUpdate" parameterType="BoardVO">
        UPDATE board
        SET b_title = #{bTitle},
            b_contents = #{bContents},
            mod_dt = SYSDATE
        WHERE u_id = #{uId}
    </update>
    <!-- 게시판에서 수정 가능 항목은 제목, 내용, 수정일이기 때문에 그 외의 컬럼은 삭제했습니다! -->
    
    <delete id="doDelete" parameterType="BoardVO">
        DELETE FROM board
        WHERE u_id = #{uId}
        AND b_seq = #{bSeq}
    </delete>    
    <!-- doDelete에 조건절을 uid만 넣으면 해당 작성자의 글이 모두 삭제되기 때문에 and 조건절로 seq를 함께 넣음! -->
    
	<!-- UserVO를 alias로 잡아두었기 때문에 사용 가능 -->
	<insert id="doInsert" parameterType="BoardVO">
		INSERT INTO board (
			b_title,
			b_contents,
			b_readcnt,
			u_nick,
			u_id
		) VALUES (
			#{bTitle},
			#{bContents},
			#{bReadCnt},
			#{uNick},
			#{uId}
		)
	</insert>
    <!-- insert쿼리에 date 뺀 이유 : 디폴트값으로 SYSDATE가 들어가고 있기 때문에 굳이 안넣어도 됨! -->
</mapper>